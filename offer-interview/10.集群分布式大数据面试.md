# 集群分布式大数据
[一口气说出 4 种分布式一致性 Session 实现方式，面试杠杠的~](https://www.cnblogs.com/goodAndyxublog/p/13327412.html)
[Spring Cloud Alibaba生态探索：Dubbo、Nacos及Sentinel的完美结合](https://www.cnblogs.com/zhuhuix/p/13710177.html)

[防止数据重复提交的6种方法(超简单)！](https://www.cnblogs.com/vipstone/p/13328386.html)

## 分布式
[五大分布式事务，你了解多少？](https://www.cnblogs.com/mingyueyy/p/13656330.html)
[这三年被分布式坑惨了，曝光十大坑](https://www.cnblogs.com/jackson0714/p/fenbushi.html)
### 分布式技术架构演化
[分析分布式技术架构演化的常用套路](https://www.cnblogs.com/zhuhuix/p/13625022.html)
```markdown
1、单机架构
2、应用服务与数据服务分离
3、应用服务器集群架构
    3.1 应用服务器集群架构下的Session管理
4、数据库读写分离
5、利用缓存技术进行加速
6、分布式数据库系统与分布式文件系统
7、NoSQL数据库作为补充
8、使用搜索引擎
9. 分布式服务
```
### 分布式锁
 分布式锁：使用数据库怎么实现？使用Redis怎么实现？使用Zookeeper怎么实现。各种实现有什么问题？比如锁泄露、可重入这些问题。这里就不一一讲解了，因为网上一搜分布式锁，讲的都很详细。
    分布式事物：二段提交、TCC、本地消息表。这三种会出现各种的优缺点？这里看下博客也就基本都没问题
    Dubbo：学习Dubbo主要看官方文档，官方文档写的非常好，里面从Dubbo的基础再到实现细节。个人感觉最好的模块是Dubbo中文网站的源码导读模块。
 
### 高并发系统的设计与实现
```markdown
在开发高并发系统时有三把利器用来保护系统：缓存、降级和限流。
    缓存：缓存比较好理解，在大型高并发系统中，如果没有缓存数据库将分分钟被爆，系统也会瞬间瘫痪。使用缓存不单单能够提升系统访问速度、提高并发访问量，
        也是保护数据库、保护系统的有效方式。大型网站一般主要是“读”，缓存的使用很容易被想到。在大型“写”系统中，缓存也常常扮演者非常重要的角色。
        比如累积一些数据批量写入，内存里面的缓存队列（生产消费），以及HBase写数据的机制等等也都是通过缓存提升系统的吞吐量或者实现系统的保护措施。
        甚至消息中间件，你也可以认为是一种分布式的数据缓存。
    降级：服务降级是当服务器压力剧增的情况下，根据当前业务情况及流量对一些服务和页面有策略的降级，以此释放服务器资源以保证核心任务的正常运行。
        降级往往会指定不同的级别，面临不同的异常等级执行不同的处理。根据服务方式：可以拒接服务，可以延迟服务，也有时候可以随机服务。
        根据服务范围：可以砍掉某个功能，也可以砍掉某些模块。总之服务降级需要根据不同的业务需求采用不同的降级策略。主要的目的就是服务虽然有损但是总比没有好。
    限流：限流可以认为服务降级的一种，限流就是限制系统的输入和输出流量已达到保护系统的目的。一般来说系统的吞吐量是可以被测算的，为了保证系统的稳定运行，
        一旦达到的需要限制的阈值，就需要限制流量并采取一些措施以完成限制流量的目的。比如：延迟处理，拒绝处理，或者部分拒绝处理等等。
``` 
### 一致性hash算法
[动手实现一致性哈希算法,并搭建环境测试其负载均衡](https://www.cnblogs.com/tanshaoshenghao/p/10816480.html)
```markdown
一致性哈希算法通过把每台服务器的哈希值打在哈希环上, 把哈希环分成不同的段, 然后对到来的请求计算哈希值从而得知该请求所归属的服务器。
    目的：这个办法解决了传统服务器增减机器时需要重新计算哈希的麻烦。
    如果服务器的数量较少,可能导致计算出的哈希值相差较小,在哈希环上分布不均匀,导致某台服务器过载。
    为了解决负载均衡问题,我们引入虚拟节点技术, 为每台服务器分配一定数量的节点, 通过节点的哈希值在哈希环上进行划分。
    这样一来，我们就可以根据机器的性能为其分配节点，性能好就多分配一点，差就少一点，从而达到负载均衡。
```
### 接口幂等性
[高并发下接口幂等性解决方案](https://www.cnblogs.com/linjiqin/p/9678022.html)
```markdown
在编程中.一个幂等操作的特点是其任意多次执行所产生的影响均与一次执行的影响相同。
幂等函数，或幂等方法，是指可以使用相同参数重复执行，并能获得相同结果的函数。这些函数不会影响系统状态，也不用担心重复执行会对系统造成改变。
二、幂等性场景
1、查询操作：查询一次和查询多次，在数据不变的情况下，查询结果是一样的。select是天然的幂等操作；
2、删除操作：删除操作也是幂等的，删除一次和多次删除都是把数据删除。(注意可能返回结果不一样，删除的数据不存在，返回0，删除的数据多条，返回结果多个) ；
3、唯一索引：防止新增脏数据。比如：支付宝的资金账户，支付宝也有用户账户，每个用户只能有一个资金账户，怎么防止给用户创建资金账户多个，那么给资金账户表中的用户ID加唯一索引，所以一个用户新增成功一个资金账户记录。要点：唯一索引或唯一组合索引来防止新增数据存在脏数据（当表存在唯一索引，并发时新增报错时，再查询一次就可以了，数据应该已经存在了，返回结果即可）；
4、token机制：防止页面重复提交。
    原理上通过session token来实现的(也可以通过redis来实现)。当客户端请求页面时，服务器会生成一个随机数Token，并且将Token放置到session当中，然后将Token发给客户端（一般通过构造hidden表单）。
    下次客户端提交请求时，Token会随着表单一起提交到服务器端。
    服务器端第一次验证相同过后，会将session中的Token值更新下，若用户重复提交，第二次的验证判断将失败，因为用户提交的表单中的Token没变，但服务器端session中Token已经改变了。
5、悲观锁
获取数据的时候加锁获取。select * from table_xxx where id='xxx' for update; 注意：id字段一定是主键或者唯一索引，不然是锁表，会死人的；悲观锁使用时一般伴随事务一起使用，数据锁定时间可能会很长，根据实际情况选用；
6、乐观锁——乐观锁只是在更新数据那一刻锁表，其他时间不锁表，所以相对于悲观锁，效率更高。乐观锁的实现方式多种多样可以通过version或者其他状态条件：
    1. 通过版本号实现update table_xxx set name=#name#,version=version+1 where version=#version#如下图(来自网上)；
    2. 通过条件限制 update table_xxx set avai_amount=avai_amount-#subAmount# where avai_amount-#subAmount# >= 0要求：quality-#subQuality# >= ，这个情景适合不用版本号，只更新是做数据安全校验，适合库存模型，扣份额和回滚份额，性能更高；
7、分布式锁
    如果是分布是系统，构建全局唯一索引比较困难，例如唯一性的字段没法确定，这时候可以引入分布式锁，通过第三方的系统(redis或zookeeper)，在业务系统插入数据或者更新数据，获取分布式锁，然后做操作，之后释放锁，这样其实是把多线程并发的锁的思路，引入多多个系统，也就是分布式系统中得解决思路。要点：某个长流程处理过程要求不能并发执行，可以在流程执行之前根据某个标志(用户ID+后缀等)获取分布式锁，其他流程执行时获取锁就会失败，也就是同一时间该流程只能有一个能执行成功，执行完成后，释放分布式锁(分布式锁要第三方系统提供)；
8、select + insert
    并发不高的后台系统，或者一些任务JOB，为了支持幂等，支持重复执行，简单的处理方法是，先查询下一些关键数据，判断是否已经执行过，在进行业务处理，就可以了。注意：核心高并发流程不要用这种方法；
9、状态机幂等
    在设计单据相关的业务，或者是任务相关的业务，肯定会涉及到状态机(状态变更图)，就是业务单据上面有个状态，状态在不同的情况下会发生变更，一般情况下存在有限状态机，这时候，如果状态机已经处于下一个状态，这时候来了一个上一个状态的变更，理论上是不能够变更的，这样的话，保证了有限状态机的幂等。注意：订单等单据类业务，存在很长的状态流转，一定要深刻理解状态机，对业务系统设计能力提高有很大帮助
10、对外提供接口的api如何保证幂等
    如银联提供的付款接口：需要接入商户提交付款请求时附带：source来源，seq序列号；source+seq在数据库里面做唯一索引，防止多次付款(并发时，只能处理一个请求) 。
重点：对外提供接口为了支持幂等调用，接口有两个字段必须传，一个是来源source，一个是来源方序列号seq，这个两个字段在提供方系统里面做联合唯一索引，这样当第三方调用时，先在本方系统里面查询一下，是否已经处理过，返回相应处理结果；没有处理过，进行相应处理，返回结果。注意，为了幂等友好，一定要先查询一下，是否处理过该笔业务，不查询直接插入业务系统，会报错，但实际已经处理了。
```
## 系统设计开发
### [以 B 站为例，聊聊站内消息系统的设计](https://mp.weixin.qq.com/s?__biz=MjM5OTMyNzQzMg==&mid=2257489580&idx=1&sn=0c1bd1486e6f8965e8d6fec07b60d659&chksm=a4470d0b9330841daae8fe3004a4d9f30bac24f56c4f88e37afc81970559a2c2057b6476b2aa&mpshare=1&scene=23&srcid=0831a5j32gLwDDOjALZfxXrk&sharer_sharetime=1598845261588&sharer_shareid=d812adcc01829f0f7f8fb06aea118511#rd)
### [手机没网了，却还能支付，这是什么原理？](https://www.cnblogs.com/goodAndyxublog/p/13605601.html)
